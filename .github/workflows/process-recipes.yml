name: Recipe Processing

on:
  schedule:
    # Run at 5am ET (9am UTC during standard time, 10am UTC during daylight time)
    # Using 9am UTC as the primary schedule
    - cron: '0 9 * * *'
#  push:
#    branches: [ main ]
  # Run on pull requests for validation
  pull_request:
    branches: [ main ]
  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Run the build with tmate debugging enabled (https://github.com/marketplace/actions/debugging-with-tmate)'
        required: false
        default: false

jobs:
  update-readme:
    name: Update README if needed
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: write
    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history
          ref: ${{ github.head_ref || github.ref }}

      - name: Setup Node Environment
        uses: ./.github/actions/setup-environment
      - name: Update README agreements table
        run: |
          # Generate new table from recipes and save to temp file
          node list-recipes.js > new_table.tmp

          # Update README.md between the markers using sed
          sed '/<!-- START_AGREEMENTS -->/,/<!-- END_AGREEMENTS -->/{
            /<!-- START_AGREEMENTS -->/r new_table.tmp
            /<!-- END_AGREEMENTS -->/!d
          }' README.md > README.md.tmp && mv README.md.tmp README.md

          # Clean up temp file
          rm new_table.tmp

      - name: Commit+Push README updates
        run: |
          # Check if README.md has changes
          if git diff --quiet README.md && git diff --staged --quiet README.md; then
            echo "No changes to README.md"
          else
            echo "README.md has changes, committing..."
            git add README.md
            git commit -m "ðŸ“‹ Update agreements table in README.md"
            git push
          fi

  process-recipes:
    name: Process Recipe Changes
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: write

    steps:
      # https://github.com/mxschmitt/action-tmate
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}
        with:
          detached: true

      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history
          ref: ${{ github.head_ref || github.ref }}

      - name: Setup Node Environment
        uses: ./.github/actions/setup-environment
        with:
          install-playwright: 'true'

      - name: Fetch base branch
        run: git fetch origin ${{ github.event.pull_request.base.ref }}:${{ github.event.pull_request.base.ref }}

      - name: Get changed recipe files
        id: changed_files
        run: |
          # Get changed recipe files between current branch and target branch
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For pull requests: compare with the target branch (main)
            CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD -- recipes/ | grep '\.json$' || true)
          else
            # For other events: no changed files to process individually
            CHANGED_FILES=""
          fi
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No recipe files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "changed_files=" >> $GITHUB_OUTPUT
          else
            echo "Changed recipe files:"
            echo "$CHANGED_FILES"
            # Convert newlines to spaces for command line usage
            CHANGED_FILES_ARGS=$(echo "$CHANGED_FILES" | tr '\n' ' ' | sed 's/[[:space:]]*$//')
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files=$CHANGED_FILES_ARGS" >> $GITHUB_OUTPUT
          fi

      # @todo write to step summary
      - name: Process recipes
        if: steps.changed_files.outputs.has_changes == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.event_name }}" = "schedule" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # For scheduled and manual runs, process all recipes
            node fetch-recipes.js --clean
          else
            # For PR/push runs, process specific changed recipes
            node fetch-recipes.js --clean --recipes ${{ steps.changed_files.outputs.changed_files }}
          fi

      - name: Generate job summary from report if available
        if: steps.changed_files.outputs.has_changes == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          if [ -f "report.md" ]; then
            echo "## Recipe Processing Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat report.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail on errors in pull requests
        if: github.event_name == 'pull_request' && hashFiles('report.md') != ''
        run: |
          echo "Recipe processing errors detected in pull request"
          exit 1

      - name: Find changed agreement files
        id: find_agreements
        if: steps.changed_files.outputs.has_changes == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          # Get all changed agreement files in one command
          AGREEMENTS=$(git diff --name-only HEAD -- agreements/ && git diff --staged --name-only agreements/ && git ls-files --others --exclude-standard agreements/ | grep '\.md$' | sort | uniq)
          
          if [ -n "$AGREEMENTS" ]; then
            echo "has_agreements=true" >> $GITHUB_OUTPUT
            echo "agreements<<EOF" >> $GITHUB_OUTPUT
            echo "$AGREEMENTS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "Found agreement files to process:"
            echo "$AGREEMENTS"
          else
            echo "has_agreements=false" >> $GITHUB_OUTPUT
            echo "No agreement files to process"
          fi

      - name: Configure Git
        if: steps.find_agreements.outputs.has_agreements == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Commit+Push agreement files
        if: steps.find_agreements.outputs.has_agreements == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Processing agreement files..."
          echo "${{ steps.find_agreements.outputs.agreements }}" | while IFS= read -r agreement_file; do
            if [ -n "$agreement_file" ]; then
              .github/scripts/commit-agreement.js "$agreement_file"
            fi
          done     
          echo "âœ… Finished processing all agreement files"
          # Push any changes (it's OK if there's nothing to push)
          git push
