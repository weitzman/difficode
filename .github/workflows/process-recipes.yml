name: Process recipes

on:
  schedule:
    # Run at 5am ET (9am UTC during standard time, 10am UTC during daylight time)
    # Using 9am UTC as the primary schedule
    - cron: '0 9 * * *'
#  push:
#    branches: [ main ]
  # Run on pull requests for validation
  pull_request:
    branches: [ main ]
  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  process-recipes:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout branch
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history
        ref: ${{ github.head_ref }}

    - name: Fetch base branch
      run: git fetch origin ${{ github.event.pull_request.base.ref }}:${{ github.event.pull_request.base.ref }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install chromium
      
    - name: Get changed recipe files
      id: changed_files
      run: |
        # Get changed recipe files between current branch and target branch
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # For pull requests: compare with the target branch (main)
          CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD -- recipes/ | grep '\.json$' || true)
        else
          # For push events: compare with previous commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- recipes/ | grep '\.json$' || true)
        fi
        
        if [ -z "$CHANGED_FILES" ]; then
          echo "No recipe files changed"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "changed_files=" >> $GITHUB_OUTPUT
        else
          echo "Changed recipe files:"
          echo "$CHANGED_FILES"
          # Convert newlines to spaces for command line usage
          CHANGED_FILES_ARGS=$(echo "$CHANGED_FILES" | tr '\n' ' ' | sed 's/[[:space:]]*$//')
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "changed_files=$CHANGED_FILES_ARGS" >> $GITHUB_OUTPUT
        fi
        
    - name: Process changed recipes
      if: steps.changed_files.outputs.has_changes == 'true'
      run: node fetch-recipes.js --clean --recipes ${{ steps.changed_files.outputs.changed_files }}
      
    - name: Check processing results and fail if errors
      if: steps.changed_files.outputs.has_changes == 'true'
      run: |
        if [ -f "report.md" ]; then
          # Check if there were any errors by looking at the report
          ERROR_COUNT=$(grep -E "^\*\*Failed:\*\* [1-9]" report.md | sed 's/.*Failed:\*\* \([0-9]\+\).*/\1/' || echo "0")
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "âŒ Recipe processing failed with $ERROR_COUNT errors"
            echo "Check the job summary for details from report.md"
            exit 1
          else
            echo "âœ… All recipes processed successfully"
          fi
        else
          echo "âš ï¸ No report.md found - this may indicate a processing failure"
          exit 1
        fi
      
    - name: Generate job summary from report
      if: always() && steps.changed_files.outputs.has_changes == 'true'
      run: |
        if [ -f "report.md" ]; then
          echo "## Recipe Processing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat report.md >> $GITHUB_STEP_SUMMARY
        else
          echo "## Recipe Processing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ No report.md generated - processing may have failed" >> $GITHUB_STEP_SUMMARY
        fi
      
    - name: No recipes to process
      if: steps.changed_files.outputs.has_changes == 'false'
      run: |
        echo "âœ… No recipe files have changed - skipping processing"
        echo "## Recipe Processing Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… No recipe files have changed - skipping processing" >> $GITHUB_STEP_SUMMARY
      
    - name: Check for changes
      id: changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if there are any changes to commit
        if git diff --quiet && git diff --staged --quiet; then
          echo "No changes to commit"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git add agreements/ report.md
        git commit -m "ğŸ“„ Recipe processing update $(date '+%Y-%m-%d')

        ğŸ¤– Generated with automated workflow
        
        Co-Authored-By: GitHub Actions <noreply@github.com>"
        git push origin ${{ github.head_ref }}
        
    - name: No changes summary
      if: steps.changes.outputs.has_changes == 'false'
      run: echo "âœ… Recipe processing completed - no changes detected"
      
    - name: Final check status
      if: always()
      run: |
        if [ "${{ job.status }}" = "failure" ]; then
          echo "âŒ Recipe processing check failed"
          exit 1
        else
          echo "âœ… Recipe processing check completed successfully"
        fi