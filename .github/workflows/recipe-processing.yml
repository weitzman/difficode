name: Recipe Processing

on:
  schedule:
    # Run at 5am ET (9am UTC during standard time, 10am UTC during daylight time)
    # Using 9am UTC as the primary schedule
    - cron: '0 9 * * *'
  # Run on pushes to main branch
  push:
    branches: [ main ]
  # Run on pull requests for validation
  pull_request:
    branches: [ main ]
  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  process-recipes:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout main branch
      uses: actions/checkout@v4
      with:
        ref: main
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install chromium
      
    - name: Process all recipes
      run: node fetch-recipes.js --clean
      
    - name: Check for changes
      id: changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if there are any changes to commit
        if git diff --quiet && git diff --staged --quiet; then
          echo "No changes to commit"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git add agreements/ report.md
        git commit -m "ðŸ“„ Daily recipe processing update $(date '+%Y-%m-%d')

        ðŸ¤– Generated with automated workflow
        
        Co-Authored-By: GitHub Actions <noreply@github.com>"
        git push origin main
        
    - name: No changes summary
      if: steps.changes.outputs.has_changes == 'false'
      run: echo "âœ… Recipe processing completed - no changes detected"